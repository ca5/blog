<!DOCTYPE html>
<html lang="jp">
<head>
        <meta charset="utf-8" />
        <title>FLとSMFとpython (準備編)</title>
        <link rel="stylesheet" href="http://ca5.github.io/blog/theme/css/main.css" />
        <link href="http://ca5.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ca5blog Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://ca5.github.io/blog/">ca5blog </a></h1>
                <nav><ul>
                    <li><a href="http://ca5.github.io/blog/category/8bit-game.html">8bit, game</a></li>
                    <li><a href="http://ca5.github.io/blog/category/8bit-game-music.html">8bit, game, music</a></li>
                    <li><a href="http://ca5.github.io/blog/category/8bit-music.html">8bit, music</a></li>
                    <li><a href="http://ca5.github.io/blog/category/8bit-music-ri-ji.html">8bit, music, 日記</a></li>
                    <li><a href="http://ca5.github.io/blog/category/8bit-music-web.html">8bit, music, web</a></li>
                    <li><a href="http://ca5.github.io/blog/category/8bit-tumblr.html">8bit, tumblr</a></li>
                    <li><a href="http://ca5.github.io/blog/category/art-music.html">art, music</a></li>
                    <li><a href="http://ca5.github.io/blog/category/art-music-ri-ji-shi-bewu.html">art, music, 日記, 食べ物</a></li>
                    <li><a href="http://ca5.github.io/blog/category/game.html">game</a></li>
                    <li><a href="http://ca5.github.io/blog/category/game-music.html">game, music</a></li>
                    <li><a href="http://ca5.github.io/blog/category/game-music-video-web.html">game, music, video, web</a></li>
                    <li><a href="http://ca5.github.io/blog/category/game-web.html">game, web</a></li>
                    <li><a href="http://ca5.github.io/blog/category/game-wu-yu.html">game, 物欲</a></li>
                    <li><a href="http://ca5.github.io/blog/category/misc.html">misc</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music.html">music</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music-neta.html">music, ネタ</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music-ri-ji.html">music, 日記</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music-tumblr-video.html">music, tumblr, video</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music-tumblr-video-neta.html">music, tumblr, video, ネタ</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music-video.html">music, video</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music-video-neta-wu-yu.html">music, video, ネタ, 物欲</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music-video-web.html">music, video, web</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music-web.html">music, web</a></li>
                    <li><a href="http://ca5.github.io/blog/category/music-wei-fen-lei.html">music, 未分類</a></li>
                    <li><a href="http://ca5.github.io/blog/category/ri-ji.html">日記</a></li>
                    <li><a href="http://ca5.github.io/blog/category/shi-bewu.html">食べ物</a></li>
                    <li><a href="http://ca5.github.io/blog/category/sonota.html">その他</a></li>
                    <li><a href="http://ca5.github.io/blog/category/sonota-ri-ji.html">その他, 日記</a></li>
                    <li><a href="http://ca5.github.io/blog/category/sonota-wu-yu.html">その他, 物欲</a></li>
                    <li><a href="http://ca5.github.io/blog/category/tumblr.html">tumblr</a></li>
                    <li><a href="http://ca5.github.io/blog/category/tumblr-video-neta-wu-yu.html">tumblr, video, ネタ, 物欲</a></li>
                    <li><a href="http://ca5.github.io/blog/category/tumblr-web.html">tumblr, web</a></li>
                    <li><a href="http://ca5.github.io/blog/category/video.html">video</a></li>
                    <li><a href="http://ca5.github.io/blog/category/video-neta.html">video, ネタ</a></li>
                    <li><a href="http://ca5.github.io/blog/category/video-web.html">video, web</a></li>
                    <li><a href="http://ca5.github.io/blog/category/video-web-neta.html">video, web, ネタ</a></li>
                    <li><a href="http://ca5.github.io/blog/category/video-web-ri-ji.html">video, web, 日記</a></li>
                    <li><a href="http://ca5.github.io/blog/category/video-wu-yu.html">video, 物欲</a></li>
                    <li><a href="http://ca5.github.io/blog/category/web.html">web</a></li>
                    <li><a href="http://ca5.github.io/blog/category/web-ri-ji.html">web, 日記</a></li>
                    <li><a href="http://ca5.github.io/blog/category/web-sonota.html">web, その他</a></li>
                    <li><a href="http://ca5.github.io/blog/category/web-sonota-neta.html">web, その他, ネタ</a></li>
                    <li><a href="http://ca5.github.io/blog/category/web-wu-yu.html">web, 物欲</a></li>
                    <li class="active"><a href="http://ca5.github.io/blog/category/wei-fen-lei.html">未分類</a></li>
                    <li><a href="http://ca5.github.io/blog/category/wu-yu.html">物欲</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://ca5.github.io/blog/fl-smf-python.html" rel="bookmark"
           title="Permalink to FLとSMFとpython (準備編)">FLとSMFとpython (準備編)</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-04-14T01:11:00+02:00">
                Published: 月 14 4月 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://ca5.github.io/blog/author/admin.html">admin</a>
        </address>
<p>In <a href="http://ca5.github.io/blog/category/wei-fen-lei.html">未分類</a>. </p>
<p>tags: <a href="http://ca5.github.io/blog/tag/fl.html">FL</a> <a href="http://ca5.github.io/blog/tag/midi.html">midi</a> <a href="http://ca5.github.io/blog/tag/python.html">python</a> </p>
</footer><!-- /.post-info -->      <p>FLで作った曲のBPMに合わせてごにょごにょする処理を自前で作りたくて色々試そうとしてます。</p>
<p>とりあえず思いついた方法が</p>
<ul>
<li>FLで曲のwavとmidiを書き出す</li>
<li>wavとmidiをpythonのスクリプトで読み込んでごにょごにょ</li>
</ul>
<p>というわけでまず準備編</p>
<h2>1. FLでmidiを吐き出す</h2>
<p>FLでこんなプロジェクトを用意</p>
<p><a href="http://firestorage.jp/download/12b13e190a604e9dcd90ff34cb7d4287f95418e5">bpmtest.zip</p>
<p></a></p>
<p>[flickr id="13820505455" thumbnail="small_320" overlay="true"
size="original" group="" align="none"]</p>
<p>2小節分のドラムループを4回ループ。3小節目からBPM変更のパターンが入って、5-6小節目中でBPMを140→54.013へ一気に下げる。</p>
<p>これのmidiを吐き出すには、まず</p>
<p>TOOLS > Macros > prepare for export</p>
<p>でmidiファイル出力に必要な適合化処理を実行する必要があります。</p>
<p>(これやらないと空のmidiファイルしか出来ない</p>
<p>で、こんなmidiファイルが出来る</p>
<p><a href="http://firestorage.jp/download/3fbc6a9cda4e58488abcfa6f0659aa980742f540">bpmtest.mid</a></p>
<h2>2. midiファイルをpythonのスクリプトで解析する</h2>
<p>midiの解析にpython-midiを使う</p>
<p><a href="https://github.com/vishnubob/python-midi">https://github.com/vishnubob/python-midi</p>
<p></a></p>
<p>pipのindexに入ってるみたいですが、</p>
<p>自分の環境だとうまくインストールできなかったのでgitのREADME通りの手順でソースからインストール。</p>
<p>すると mididump.py
というサンプルスクリプトも一緒にインストールされるので試してみる。</p>
<dl>
<dt>[bash]</dt>
<dt>\$ mididump.py ./bpmtest.mid | less</dt>
<dt>midi.Pattern(format=1, resolution=96, tracks=\</dt>
<dt>[midi.Track(\</dt>
<dt>[midi.TimeSignatureEvent(tick=0, data=[4, 2, 24, 8]),</dt>
<dt>midi.EndOfTrackEvent(tick=0, data=[])]),</dt>
<dt>midi.Track(\</dt>
<dt>[midi.SetTempoEvent(tick=0, data=[16, 243, 60]),</dt>
<dt>midi.SetTempoEvent(tick=0, data=[6, 138, 27]),</dt>
<dt>midi.SetTempoEvent(tick=768, data=[6, 138, 27]),</dt>
<dt>midi.SetTempoEvent(tick=768, data=[6, 254, 136]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[7, 111, 252]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[7, 211, 193]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[8, 14, 176]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[8, 109, 233]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[8, 190, 72]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[9, 73, 112]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[9, 215, 214]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[10, 103, 106]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[10, 226, 237]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[11, 126, 229]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[12, 22, 109]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[12, 241, 204]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[13, 208, 171]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[14, 207, 174]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[16, 30, 101]),</dt>
<dt>midi.SetTempoEvent(tick=24, data=[16, 243, 60]),</dt>
<dt>midi.EndOfTrackEvent(tick=0, data=[])]),</dt>
<dt>midi.Track(\</dt>
<dt>[midi.TrackNameEvent(tick=0, text='Sampler (MIDI)', data=[83, 97, 109,</dt>
<dt>112, 108, 101, 114, 32, 40, 77, 73, 68, 73, 41]),</dt>
<dt>midi.ControlChangeEvent(tick=0, channel=0, data=[10, 64]),</dt>
<dt>midi.ControlChangeEvent(tick=0, channel=0, data=[7, 100]),</dt>
<dt>midi.PitchWheelEvent(tick=0, channel=0, data=[0, 64]),</dt>
<dd></dd>
<dd>[/bash]</dd>
</dl>
<p>これだけだとあんまり良くわからないので</p>
<p>こんなサイトを参考に<a href="http://www2s.biglobe.ne.jp/~yyagi/material/smfspec.html">http://www2s.biglobe.ne.jp/~yyagi/material/smfspec.html</a></p>
<p>以下引用</p>
<blockquote>
<p>SMFの実際</p>
<p>テンポ120で、四分音符でドレ、全音符でミを鳴らすSMF。</p>
<p>ランニングステータスが多用されていることに注意。
また、ランニングステータスの効果を高めるために、 ノートオフとして 9n
kk 00 (ベロシティゼロでノートオン) を使用している。</p>
<p>000000 4D 54 68 64 00 00 00 06 00 01 00 02 00 30 4D 54 /
MThd.........0MT</p>
<p>000010 72 6B 00 00 00 0B 00 FF 51 03 07 A1 20 00 FF 2F /
rk......Q....../</p>
<p>000020 00 4D 54 72 6B 00 00 00 18 00 90 3C 7F 30 3C 00 /
.MTrk.....・0.0>..@..0@.../</p>
<p>000040 00 / .</p>
<p>ヘッダ</p>
<p>4D 54 68 64 "MThd"</p>
<p>00 00 00 06 ブロック長(6)</p>
<p>00 01 フォーマット(1)</p>
<p>00 02 トラック数(2)</p>
<p>00 30 四分音符の分解能(0x30=48)</p>
<p>トラック1のデータ (Conductor Track)</p>
<p>4D 54 72 6B "MTrk"</p>
<p>00 00 00 0B ブロック長(0x0B=11)</p>
<p>00 FF 51 03 07 A1 20 テンポ(120)</p>
<p>00 FF 2F 00 トラックエンド</p>
<p>トラック2のデータ (演奏トラックその1)</p>
<p>4D 54 72 6B "MTrk"</p>
<p>00 00 00 18 ブロック長(0x18=24)</p>
<p>00 90 3C 7F ベロシティ127でノート3Cをノートオン</p>
<p>30 3C 00 48tick後、ノート3Cをノートオフ</p>
<p>00 3E 7F 直後に、ベロシティ127でノート3Eをノートオン</p>
<p>30 3E 00 48tick後、ノート3Eをノートオフ</p>
<p>00 40 7F 直後に、ベロシティ127でノート40をノートオン</p>
<p>81 40 40 00 192tick後、ノート40をノートオフ</p>
<p>00 FF 2F 00 トラックエンド</p>
<p>FF 51 03 tttttt : テンポ設定 (単位は μsec / MIDI 四分音符)</p>
<p>このイベントでテンポ変更を指示する。</p>
<p>tttttt (3byte) には、四分音符の長さをマイクロ秒 (μsec)
で表したものを格納する。</p>
<p>例えば、BPM=120 (1分あたり四分音符が120個)の場合、 四分音符の長さは 60
x 106 / 120 = 500,000 (μsec)。
これを16進にすると0x07A120。従って、メタイベントは</p>
<p>FF 51 03 07 A1 20</p>
<p>となる。</p>
</blockquote>
<p>/引用終わり</p>
<p>・・・ということなのでSetTempoEventの部分をみてみると<br />
[bash][midi.SetTempoEvent(tick=0, data=[16, 243, 60]),<br />
midi.SetTempoEvent(tick=0, data=[6, 138, 27]),<br />
midi.SetTempoEvent(tick=768, data=[6, 138, 27]),<br />
midi.SetTempoEvent(tick=768, data=[6, 254, 136]),<br />
midi.SetTempoEvent(tick=24, data=[7, 111, 252]),<br />
midi.SetTempoEvent(tick=24, data=[7, 211, 193]),<br />
midi.SetTempoEvent(tick=24, data=[8, 14, 176]),<br />
midi.SetTempoEvent(tick=24, data=[8, 109, 233]),<br />
midi.SetTempoEvent(tick=24, data=[8, 190, 72]),<br />
midi.SetTempoEvent(tick=24, data=[9, 73, 112]),<br />
midi.SetTempoEvent(tick=24, data=[9, 215, 214]),<br />
midi.SetTempoEvent(tick=24, data=[10, 103, 106]),<br />
midi.SetTempoEvent(tick=24, data=[10, 226, 237]),<br />
midi.SetTempoEvent(tick=24, data=[11, 126, 229]),<br />
midi.SetTempoEvent(tick=24, data=[12, 22, 109]),<br />
midi.SetTempoEvent(tick=24, data=[12, 241, 204]),<br />
midi.SetTempoEvent(tick=24, data=[13, 208, 171]),<br />
midi.SetTempoEvent(tick=24, data=[14, 207, 174]),<br />
midi.SetTempoEvent(tick=24, data=[16, 30, 101]),<br />
midi.SetTempoEvent(tick=24, data=[16, 243, 60]),<br />
midi.EndOfTrackEvent(tick=0, data=[])]),[/bash]</p>
<p>BPMはdataの部分の数値を3byteの数値と見れば良い<br />
data=[6, 138, 27]の場合は<br />
[bash]<br />
27 + 256\^1 * 138 + 256\^2 * 6 = 428571(μsec)→4分音符の長さ<br />
BPM = 60000000 / 428571 = 140.00014000014 ≒ 140<br />
[/bash]<br />
となる</p>
<p>1.
BPMを54.012に設定(プロジェクト最後のBPMをとりあえず最初につけてしまっている？)<br />
2. BPMを140に設定 (1.からtick=0差なのですぐにこのBPMが適用される)<br />
3. 2小節後(tick=96*4*2=768)にBPMを140に設定<br />
4. 2小節後にBPMを130.896に設定<br />
5. 以下16分音符ごとの間隔でBPMを54.012へ下げていく</p>
<p>となっているのがわかりますね。<br />
あとはこれを元にごにょごにょやるだけ。<br />
気が向いたら続きを書きます。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://ca5.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>